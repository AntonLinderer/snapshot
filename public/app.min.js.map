{"version":3,"file":"app.min.js","sources":["../src/view-state.ts","../src/constants.ts","../src/image-db.ts","../src/views/view.ts","../src/views/browse-view.ts","../src/promise-helpers.ts","../src/camera-helper.ts","../src/image-record.ts","../src/views/capture-view.ts","../src/filters/filter-transform.ts","../src/filters/image-shader.ts","../src/filters/named-filter.ts","../src/views/edit-view.ts","../src/views/upload-view.ts","../src/router.ts","../src/index.ts"],"sourcesContent":["/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filters/filter-transform';\n\nexport default class ViewState {\n  id?: number;\n  transform?: FilterTransform;\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nexport default {\n  IMAGE_TYPE: 'image/jpeg',\n  SUPPORTS_IMAGE_CAPTURE: 'ImageCapture' in window,\n  SUPPORTS_MEDIA_DEVICES: 'mediaDevices' in navigator,\n};\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ImageRecord from './image-record';\n\nconst DB_VERSION = 2;\n\nclass ImageDB {\n  private dbPromise: Promise<IDBDatabase>;\n  private dbResolve: (value: IDBDatabase) => void;\n  private dbReject: (reason: any) => void;\n\n  constructor() {\n    const request = indexedDB.open('image-db', DB_VERSION);\n\n    this.dbPromise = new Promise((resolve, reject) => {\n      this.dbResolve = resolve;\n      this.dbReject = reject;\n\n      request.onerror = (reason) => this.dbReject(reason);\n      request.onupgradeneeded = (event) => this.createObjectStore(event);\n      request.onsuccess = (event) => this.dbOpened(request);\n    });\n  }\n\n  /**\n   * Store an image in the database. If the `id` property of the record is not\n   * set, this will create a new entry. Returns the ID of the record.\n   */\n  store(record: ImageRecord): Promise<number> {\n    const promise: Promise<number> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['images'], 'readwrite');\n        const put = transaction.objectStore('images').put(record);\n\n        put.onsuccess = (event) => resolve(put.result);\n        put.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  retrieve(id: number): Promise<ImageRecord> {\n    const promise: Promise<ImageRecord> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['images'], 'readonly');\n        const get = transaction.objectStore('images').get(id);\n\n        get.onsuccess = (event) => resolve(get.result);\n        get.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  all(): Promise<ImageRecord[]> {\n    const promise: Promise<ImageRecord[]> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['images'], 'readonly');\n        const open = transaction.objectStore('images').openCursor();\n        const results: ImageRecord[] = [];\n\n        open.onsuccess = (event) => {\n          const cursor = open.result as IDBCursorWithValue;\n\n          if (cursor) {\n            results.push(cursor.value);\n            cursor.continue();\n          } else {\n            resolve(results);\n          }\n        };\n        open.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  private dbOpened(request: IDBOpenDBRequest) {\n    this.dbResolve(request.result);\n    this.dbPromise.then((db) => {\n      db.onerror = (reason) => this.error(reason);\n    });\n  }\n\n  private error(reason) {\n    console.error(reason);\n  }\n\n  private createObjectStore(event: IDBVersionChangeEvent) {\n    const request: IDBOpenDBRequest = event.target as IDBOpenDBRequest;\n    const db: IDBDatabase = request.result;\n\n    switch (event.oldVersion) {\n      case 1:\n        db.deleteObjectStore('images');\n      case 0:\n        db.createObjectStore('images', {keyPath: \"id\", autoIncrement: true});\n    }\n  }\n}\n\nexport default new ImageDB();\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ViewState from '../view-state';\n\nexport default class View {\n  protected viewElement: HTMLElement;\n  private state?: ViewState;\n\n  constructor(viewElement: HTMLElement) {\n    this.viewElement = viewElement;\n  }\n\n  show(): void {\n    this.viewElement.classList.remove('hidden');\n  }\n\n  hide(): void {\n    this.viewElement.classList.add('hidden');\n  }\n\n  getState(): ViewState {\n    return this.state || new ViewState();\n  }\n\n  setState(state: ViewState) {\n    this.state = state;\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from '../constants';\nimport db from '../image-db';\nimport ImageRecord from '../image-record';\nimport router from '../router';\nimport ViewState from '../view-state';\nimport View from './view';\n\nexport default class BrowseView extends View {\n  private captureButton: HTMLButtonElement;\n  private uploadButton: HTMLButtonElement;\n  private emptyListElement: HTMLElement;\n  private listElement: HTMLElement;\n  private blobURLs: Set<string>;\n\n  constructor() {\n    super(document.getElementById('browse-view')!);\n\n    this.captureButton = document.getElementById('browse-capture-button') as HTMLButtonElement;\n    this.uploadButton = document.getElementById('browse-upload-button') as HTMLButtonElement;\n    this.emptyListElement = document.getElementById('empty-browse-list') as HTMLButtonElement;\n    this.listElement = document.getElementById('browse-list') as HTMLButtonElement;\n\n    if (!constants.SUPPORTS_MEDIA_DEVICES) {\n      this.captureButton.classList.add('hidden');\n    }\n\n    this.captureButton.addEventListener('click', () => this.captureClick());\n    this.uploadButton.addEventListener('click', () => this.uploadClick());\n\n    this.blobURLs = new Set();\n  }\n\n  async show() {\n    const photos = await db.all();\n\n    if (photos.length === 0) {\n      this.emptyListElement.classList.remove('hidden');\n      this.listElement.classList.add('hidden');\n    } else {\n      this.emptyListElement.classList.add('hidden');\n      this.listElement.classList.remove('hidden');\n\n      for (const record of photos) {\n        const thumb = document.createElement('div');\n        thumb.classList.add('element');\n        thumb.addEventListener('click', () => router.visit(`/edit/${record.id}`));\n\n        const buffer = record.thumbnail || record.edited || record.original;\n        if (buffer) {\n          const blob = new Blob([buffer], {type: constants.IMAGE_TYPE});\n          const url = URL.createObjectURL(blob);\n          const image = document.createElement('img');\n          image.src = url;\n          thumb.appendChild(image);\n          this.blobURLs.add(url);\n        } else {\n          // TODO: Handle this error condition\n        }\n        this.listElement.appendChild(thumb);\n      }\n    }\n\n    super.show();\n  }\n\n  hide() {\n    super.hide();\n    // TODO: Have a good think about this. The strategy here is to remove all\n    // child elements when we hide, because smaller DOM seems like a win for the\n    // rest of the app. But really we probably want a recycler instead...\n    while (this.listElement.hasChildNodes()) {\n      this.listElement.removeChild(this.listElement.lastChild!);\n    }\n    for (const url of this.blobURLs) {\n      URL.revokeObjectURL(url);\n    }\n    this.blobURLs.clear();\n  }\n\n  captureClick() {\n    router.visit('/capture');\n  }\n\n  uploadClick() {\n    router.visit('/upload');\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nexport function canvasToBlob(canvas: HTMLCanvasElement, type: string): Promise<Blob> {\n  return new Promise((resolve) => {\n    canvas.toBlob((blob: Blob) => resolve(blob), type);\n  });\n}\n\nexport function blobToArrayBuffer(blob: Blob): Promise<ArrayBuffer> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.addEventListener('loadend', async (e: ProgressEvent) => {\n      resolve(reader.result);\n    });\n    reader.addEventListener('error', reject);\n    reader.readAsArrayBuffer(blob);\n  });\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from './constants';\nimport {canvasToBlob} from './promise-helpers';\n\nconst streamConstraints: MediaStreamConstraints = {\n  video: {\n    deviceId: '',\n    facingMode: ['user', 'environment'],\n    height: {ideal: 1080},\n    width: {ideal: 1920},\n  },\n};\n\nlet supportedConstraints: MediaTrackSupportedConstraints = {};\n\nif (constants.SUPPORTS_MEDIA_DEVICES) {\n  supportedConstraints = navigator.mediaDevices.getSupportedConstraints();\n}\n\nexport default class CameraHelper {\n  private stream: MediaStream | null;\n  private track: MediaStreamTrack | null;\n  private trackConstraints: MediaTrackSettings;\n\n  constructor() {\n    this.stream = null;\n    this.track = null;\n\n    this.trackConstraints = {};\n  }\n\n  async getCameras() {\n    let devices: MediaDeviceInfo[] = [];\n\n    if (constants.SUPPORTS_MEDIA_DEVICES) {\n      devices = await navigator.mediaDevices.enumerateDevices();\n      devices = devices.filter((device) => device.kind === 'videoinput');\n    }\n\n    return devices;\n  }\n\n  async takePhoto(video: HTMLVideoElement): Promise<Blob | null> {\n    if (!constants.SUPPORTS_MEDIA_DEVICES) {\n      return null;\n    }\n\n    if (constants.SUPPORTS_IMAGE_CAPTURE) {\n      const stream = video.srcObject;\n\n      if (!stream) {\n        return null;\n      }\n\n      const track = stream.getVideoTracks()[0];\n      const capture = new ImageCapture(track);\n      const settings: PhotoSettings = {};\n\n      return await capture.takePhoto(settings);\n    } else {\n      const canvas = document.createElement('canvas');\n      const context = canvas.getContext('2d')!;\n      canvas.width = video.videoWidth;\n      canvas.height = video.videoHeight;\n      context.drawImage(video, 0, 0);\n\n      return await canvasToBlob(canvas, constants.IMAGE_TYPE);\n    }\n  }\n\n  stopStream() {\n    if (this.stream) {\n      for (const track of this.stream.getVideoTracks()) {\n        track.stop();\n      }\n    }\n  }\n\n  async startStream(deviceId) {\n    this.stopStream();\n\n    (streamConstraints.video as MediaTrackConstraints).deviceId = deviceId;\n\n    const stream = await navigator.mediaDevices.getUserMedia(streamConstraints);\n    this.stream = stream;\n    this.track = stream.getVideoTracks()[0];\n    this.trackConstraints = {};\n    return stream;\n  }\n\n  getSettings(): MediaTrackSettings {\n    if (!this.track || !this.track.getSettings) {\n      return {};\n    }\n    return this.track.getSettings();\n  }\n\n  getCapabilities(): MediaTrackCapabilities {\n    if (!this.track || !this.track.getCapabilities) {\n      return {};\n    }\n    return this.track.getCapabilities();\n  }\n\n  setConstraint(name: string, value: any) {\n    if (supportedConstraints[name]) {\n      const capabilities = this.getCapabilities();\n      console.log(capabilities[name], name, value);\n      if (capabilities[name]) {\n        this.trackConstraints[name] = value;\n      }\n    }\n    return this.applyConstraints();\n  }\n\n  applyConstraints() {\n    if (this.track && this.track.applyConstraints) {\n      const constraints = this.track.getConstraints();\n      const advanced: MediaTrackConstraintSet[] = constraints.advanced || [];\n\n      for (const [name, value] of Object.entries(this.trackConstraints)) {\n        const constraint = {};\n        constraint[name] = value;\n        advanced.push(constraint);\n      }\n\n      if (advanced.length > 0) {\n        constraints.advanced = advanced;\n      }\n\n      return this.track.applyConstraints(constraints);\n    }\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filters/filter-transform';\n\nexport default class ImageRecord {\n  id: number | null;\n  readonly original: ArrayBuffer;\n  edited: ArrayBuffer | null;\n  thumbnail: ArrayBuffer | null;\n  transform: FilterTransform | null;\n\n  constructor(original: ArrayBuffer) {\n    this.original = original;\n    this.edited = null;\n    this.thumbnail = null;\n    this.transform = null;\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport CameraHelper from '../camera-helper';\nimport constants from '../constants';\nimport db from '../image-db';\nimport ImageRecord from '../image-record';\nimport {blobToArrayBuffer} from '../promise-helpers';\nimport router from '../router';\nimport ViewState from '../view-state';\nimport View from './view';\n\nexport default class CaptureView extends View {\n  private videoElement: HTMLVideoElement;\n  private videoElement2: HTMLVideoElement;\n  private takePhotoButton: HTMLButtonElement;\n  private cameraChooseButton: HTMLButtonElement;\n  private mirrorButton: HTMLButtonElement;\n  private closeButton: HTMLButtonElement;\n\n  private cameraHelper: CameraHelper;\n\n  private devicesPromise: Promise<MediaDeviceInfo[]>;\n  private currentDevice: MediaDeviceInfo | null;\n\n  constructor() {\n    super(document.getElementById('capture-view')!);\n    this.videoElement = this.viewElement.querySelector('video#preview')! as HTMLVideoElement;\n    this.videoElement2 = this.viewElement.querySelector('video#preview2')! as HTMLVideoElement;\n    this.takePhotoButton = document.getElementById('capture-button')! as HTMLButtonElement;\n    this.cameraChooseButton = document.getElementById('camera-choose-button')! as HTMLButtonElement;\n    this.mirrorButton = document.getElementById('capture-mirror-button')! as HTMLButtonElement;\n    this.closeButton = document.getElementById('capture-view-close')! as HTMLButtonElement;\n\n    this.videoElement2.classList.add('hidden');\n\n    this.cameraHelper = new CameraHelper();\n\n    this.takePhotoButton.addEventListener('click', () => this.takePhoto());\n    this.cameraChooseButton.addEventListener('click', () => this.toggleCameraChooser());\n    this.mirrorButton.addEventListener('click', () => this.toggleMirror());\n    this.closeButton.addEventListener('click', () => this.close());\n\n    this.devicesPromise = this.getDevices();\n    this.currentDevice = null;\n  }\n\n  show() {\n    this.devicesPromise.then((devices) => {\n      this.currentDevice = devices[0];\n      this.startStream(this.currentDevice.deviceId);\n    });\n    super.show();\n  }\n\n  hide() {\n    this.cameraHelper.stopStream();\n    this.videoElement.pause();\n    super.hide();\n  }\n\n  async getDevices() {\n    const cameras = await this.cameraHelper.getCameras();\n\n    if (cameras.length < 2) {\n      this.cameraChooseButton.classList.add('hidden');\n    } else {\n      this.cameraChooseButton.classList.remove('hidden');\n    }\n\n    return cameras;\n  }\n\n  async takePhoto() {\n    const blob = await this.cameraHelper.takePhoto(this.videoElement);\n    if (blob) {\n      this.storeResult(blob);\n    } else {\n      // TODO: This is an unhandled error condition\n    }\n  }\n\n  async toggleCameraChooser() {\n    // Four possible cases\n    // 1. No camera! This view shouldn't even come up, we need a fallback UI\n    // 2. One camera. Button should be hidden.\n    // 3. Two cameras. Clicking button is a simple toggle.\n    // 4. Three or more cameras. Present a chooser with the names and/or\n    //    features of the cameras.\n    // TODO: Need to change the button to reflect the kind of camera that will\n    // be selected.\n    // TODO: Need to decide what happens if we change camera while recording\n    const devices = await this.devicesPromise;\n    if (devices.length < 2) {\n      return;\n    }\n\n    if (this.currentDevice) {\n      const currentIndex = devices.indexOf(this.currentDevice);\n\n      // TODO: Should show chooser for many devices, not just cycle\n      this.currentDevice = devices[(currentIndex + 1) % devices.length];\n    } else {\n      this.currentDevice = devices[0];\n    }\n\n    this.startStream(this.currentDevice.deviceId);\n  }\n\n  close() {\n    router.visit(`/browse`);\n  }\n\n  private async storeResult(blob: Blob) {\n    const buffer = await blobToArrayBuffer(blob);\n    const record = new ImageRecord(buffer);\n    const id = await db.store(record);\n    router.visit(`/edit/${id}`);\n  }\n\n  private async startStream(deviceId) {\n    const stream = await this.cameraHelper.startStream(deviceId);\n    this.videoElement2.srcObject = stream;\n    this.videoElement2.onloadedmetadata = () => {\n      const temp = this.videoElement;\n      this.videoElement = this.videoElement2;\n      this.videoElement2 = temp;\n      this.videoElement.play();\n      const settings = this.cameraHelper.getSettings();\n      if (settings.facingMode === 'user') {\n        this.videoElement.classList.add('mirror');\n      } else {\n        this.videoElement.classList.remove('mirror');\n      }\n      this.videoElement.classList.remove('hidden');\n      this.videoElement2.classList.add('hidden');\n      this.videoElement2.pause();\n    };\n  }\n\n  private toggleMirror() {\n    this.videoElement.classList.toggle('mirror');\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nconst random = (min: number, max: number): number => {\n  let result = Math.random();\n  result *= (max - min);\n  result += min;\n  return result;\n};\n\nexport default class FilterTransform {\n  saturation: number;\n  warmth: number;\n  sharpen: number;\n  blur: number;\n  brightness: number;\n  contrast: number;\n  grey: number;\n  vignette: number;\n\n  constructor() {\n    this.saturation = 1;\n    this.warmth = 0;\n    this.sharpen = 0;\n    this.blur = 1;\n    this.brightness = 1;\n    this.contrast = 1;\n    this.grey = 0.5;\n    this.vignette = 2;\n  }\n\n  // This allows us to `for (... of ...)` over the filters\n  // I really feel like there should be a simpler/clearer way to express this\n  [Symbol.iterator]() {\n    return function*() {\n      yield ['saturation', this.saturation];\n      yield ['warmth', this.warmth];\n      yield ['sharpen', this.sharpen];\n      yield ['blur', this.blur];\n      yield ['brightness', this.brightness];\n      yield ['contrast', this.contrast];\n      yield ['grey', this.grey];\n      yield ['vignette', this.vignette];\n    }.bind(this)();\n  }\n\n  randomize() {\n    this.saturation = random(0, 2);\n    this.warmth = random(-0.08, 0.08);\n    this.sharpen = random(-2, 2);\n    this.blur = random(0.01, 4);\n    this.brightness = random(0, 2);\n    this.contrast = random(0, 2);\n    this.grey = random(0, 1);\n    this.vignette = random(0.2, 2);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nconst BASE_VERTEX_SHADER = `\nattribute vec2 position;\nattribute vec2 uv;\n\nvarying vec2 texCoords;\n\nvoid main() {\n  gl_Position = vec4(position, 0, 1.0);\n  texCoords = uv;\n}`;\n\nconst BASE_FRAGMENT_SHADER = `\nprecision highp float;\n\nvarying vec2 texCoords;\n\nuniform sampler2D textureSampler;\n\nvoid main() {\n  gl_FragColor = texture2D(textureSampler, texCoords);\n}`;\n\nconst POSITIONS = new Float32Array([-1, -1, -1, 1, 1, 1, 1, -1]);\nconst UVS = new Float32Array([0, 1, 0, 0, 1, 0, 1, 1]);\nconst INDEX = new Uint16Array([0, 1, 2, 0, 2, 3]);\n\nclass UniformInfo {\n  type: GLenum;\n  location: WebGLUniformLocation;\n}\n\nexport default class ImageShader {\n  canvas: HTMLCanvasElement;\n  context: WebGLRenderingContext;\n\n  private textureId: WebGLTexture;\n  private programId: WebGLProgram;\n  private vertShader: string;\n  private fragShader: string;\n\n  private uniformLocations: Map<string, UniformInfo>;\n  private dirtyProgram: boolean;\n\n  constructor() {\n    this.canvas = document.createElement('canvas');\n    const context = this.canvas.getContext('webgl');\n\n    if (context === null) {\n      throw new Error(`Couldn't get a WebGL context`);\n    }\n\n    const gl: WebGLRenderingContext = context as WebGLRenderingContext;\n    this.context = gl;\n    const textureId = gl.createTexture();\n\n    if (textureId === null) {\n      throw new Error('Error getting texture ID');\n    }\n\n    this.textureId = textureId;\n    this.programId = 0;\n\n    this.vertShader = BASE_VERTEX_SHADER;\n    this.fragShader = BASE_FRAGMENT_SHADER;\n\n    this.uniformLocations = new Map();\n\n    this.createVAO(INDEX, POSITIONS, UVS);\n\n    gl.clearColor(1, 1, 1, 1);\n\n    this.dirtyProgram = true;\n  }\n\n  setImage(image: HTMLImageElement | HTMLVideoElement | HTMLCanvasElement) {\n    const gl = this.context;\n    gl.activeTexture(gl.TEXTURE0);\n    gl.bindTexture(gl.TEXTURE_2D, this.textureId);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n    // gl.generateMipmap(gl.TEXTURE_2D);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n  }\n\n  setVertexShader(source: string) {\n    this.vertShader = source;\n    this.dirtyProgram = true;\n  }\n\n  setFragmentShader(source: string) {\n    this.fragShader = source;\n    this.dirtyProgram = true;\n  }\n\n  setUniform(name: string, value: any) {\n    const gl = this.context;\n\n    if (this.dirtyProgram) {\n      this.createProgram();\n    }\n\n    if (!this.uniformLocations.has(name)) {\n      console.warn(`Tried to set unknown uniform ${name}`);\n      return;\n    }\n\n    const info = this.uniformLocations.get(name)!;\n\n    switch (info.type) {\n      case gl.FLOAT:\n        gl.uniform1fv(info.location, [value]);\n        break;\n      case gl.FLOAT_VEC2:\n        gl.uniform2fv(info.location, value);\n        break;\n      case gl.FLOAT_VEC3:\n        gl.uniform3fv(info.location, value);\n        break;\n      case gl.FLOAT_VEC4:\n        gl.uniform4fv(info.location, value);\n        break;\n      case gl.BOOL:\n      case gl.INT:\n        gl.uniform1iv(info.location, [value]);\n        break;\n      case gl.BOOL_VEC2:\n      case gl.INT_VEC2:\n        gl.uniform2iv(info.location, value);\n        break;\n      case gl.BOOL_VEC3:\n      case gl.INT_VEC3:\n        gl.uniform3iv(info.location, value);\n        break;\n      case gl.BOOL_VEC4:\n      case gl.INT_VEC4:\n        gl.uniform4iv(info.location, value);\n        break;\n      default:\n        console.error(`Couldn't set uniform, unsupported type`);\n    }\n  }\n\n  render() {\n    const gl = this.context;\n\n    if (this.dirtyProgram) {\n      this.createProgram();\n    }\n\n    gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);\n    gl.flush();\n  }\n\n  private createProgram() {\n    const gl = this.context;\n\n    const vertexShaderId = this.compileShader(this.vertShader, gl.VERTEX_SHADER);\n    const fragmentShaderId = this.compileShader(this.fragShader, gl.FRAGMENT_SHADER);\n    const programId = gl.createProgram();\n    if (programId === null) {\n      throw new Error(`Couldn't get a program ID`);\n    }\n    this.programId = programId;\n    gl.attachShader(programId, vertexShaderId);\n    gl.attachShader(programId, fragmentShaderId);\n    gl.linkProgram(programId);\n    if (!gl.getProgramParameter(programId, gl.LINK_STATUS)) {\n      const info = gl.getProgramInfoLog(programId);\n      throw new Error('Could not link shader program. \\n\\n' + info);\n    }\n    gl.validateProgram(programId);\n    if (!gl.getProgramParameter(programId, gl.VALIDATE_STATUS)) {\n      const info = gl.getProgramInfoLog(programId);\n      throw new Error('Could not validate shader program. \\n\\n' + info);\n    }\n    gl.useProgram(programId);\n    this.uniformLocations = new Map();\n    this.getUniformLocations();\n\n    this.dirtyProgram = false;\n  }\n\n  private compileShader(source: string, type: number): WebGLShader {\n    const gl = this.context;\n    const shader = gl.createShader(type);\n\n    if (shader === null) {\n      throw new Error('Error creating shader');\n    }\n\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\n      throw new Error(`Couldn't compiler shader: ${gl.getShaderInfoLog(shader)}`);\n    }\n    return shader;\n  }\n\n  private getUniformLocations() {\n    const gl = this.context;\n    const numUniforms = gl.getProgramParameter(this.programId, gl.ACTIVE_UNIFORMS);\n    for (let i = 0; i < numUniforms; i++) {\n      const info = gl.getActiveUniform(this.programId, i);\n      if (info === null) {\n        throw new Error(`Couldn't get uniform info`);\n      }\n      const location = gl.getUniformLocation(this.programId, info.name);\n      if (location) {\n        this.uniformLocations.set(info.name, {type: info.type, location});\n      }\n    }\n  }\n\n  private createVAO(index, positions, uvs) {\n    const gl = this.context;\n    const ext = gl.getExtension('OES_vertex_array_object');\n    if (!ext) {\n      throw new Error(`Browser doesn't support VAOs`);\n    }\n    const vaoId = ext.createVertexArrayOES();\n    ext.bindVertexArrayOES(vaoId);\n    this.bindIndicesBuffer(index);\n    this.bindAttributeBuffer(0, 2, positions);\n    this.bindAttributeBuffer(1, 2, uvs);\n    gl.enableVertexAttribArray(0);\n    gl.enableVertexAttribArray(1);\n  }\n\n  private bindAttributeBuffer(attributeNumber, size, data) {\n    const gl = this.context;\n    const id = gl.createBuffer();\n    gl.bindBuffer(gl.ARRAY_BUFFER, id);\n    gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);\n    gl.vertexAttribPointer(attributeNumber, size, gl.FLOAT, false, 0, 0);\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\n  }\n\n  private bindIndicesBuffer(data) {\n    const gl = this.context;\n    const id = gl.createBuffer();\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, id);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, data, gl.STATIC_DRAW);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filter-transform';\n\nexport class NamedFilter {\n  name: string;\n  values: FilterTransform;\n\n  constructor() {\n    this.name = '';\n    this.values = new FilterTransform();\n  }\n}\n\nexport const namedFilters: NamedFilter[] = [\n  {\n    name: 'Grimsby',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Slough',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Burnley',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Carlisle',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Stevenage',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Hull',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Swansea',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Luton',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Glasgow',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Dull',\n    values: new FilterTransform(),\n  },\n];\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from '../constants';\nimport fragmentShader from '../filters/filter-fragment-shader.glsl';\nimport FilterTransform from '../filters/filter-transform';\nimport ImageShader from '../filters/image-shader';\nimport {NamedFilter, namedFilters} from '../filters/named-filter';\nimport db from '../image-db';\nimport ImageRecord from '../image-record';\nimport {blobToArrayBuffer, canvasToBlob} from '../promise-helpers';\nimport router from '../router';\nimport ViewState from '../view-state';\nimport View from './view';\n\nexport default class EditView extends View {\n  private destElement: HTMLDivElement;\n  private sourceElement: HTMLImageElement | null;\n  private sourceWidth: number;\n  private sourceHeight: number;\n  private closeButton: HTMLButtonElement;\n  private acceptButton: HTMLButtonElement;\n  private sliders: Map<string, HTMLInputElement>;\n  private effectButtons: Set<HTMLButtonElement>;\n  private filterSectionButton: HTMLButtonElement;\n  private tuneSectionButton: HTMLButtonElement;\n  private filterSection: HTMLDivElement;\n  private tuneSection: HTMLDivElement;\n  private animationFrame: number;\n  private imageShader: ImageShader;\n  private currentRecord: ImageRecord | null;\n  private currentPanel: Element | null;\n  private transform: FilterTransform;\n\n  constructor() {\n    super(document.getElementById('edit-view')!);\n\n    this.destElement = document.getElementById('edit-dest')! as HTMLDivElement;\n    this.closeButton = document.getElementById('edit-view-close')! as HTMLButtonElement;\n    this.acceptButton = document.getElementById('edit-view-accept')! as HTMLButtonElement;\n    this.filterSectionButton = document.getElementById('edit-select-filters')! as HTMLButtonElement;\n    this.tuneSectionButton = document.getElementById('edit-select-tuning')! as HTMLButtonElement;\n    this.filterSection = document.getElementById('edit-filter')! as HTMLDivElement;\n    this.tuneSection = document.getElementById('edit-tune')! as HTMLDivElement;\n\n    this.closeButton.addEventListener('click', () => this.closeClick());\n    this.acceptButton.addEventListener('click', () => this.acceptClick());\n    this.filterSectionButton.addEventListener('click', () => this.toggleSection());\n    this.tuneSectionButton.addEventListener('click', () => this.toggleSection());\n\n    this.transform = new FilterTransform();\n\n    this.sliders = new Map();\n\n    const sliderElements = this.viewElement.getElementsByTagName('input');\n\n    for (const slider of Array.from(sliderElements)) {\n      this.sliders.set(slider.id, slider);\n\n      slider.addEventListener('input', () => {\n        this.transform[slider.id] = Number(slider.value) / 50;\n        if (!this.animationFrame) {\n          this.animationFrame = requestAnimationFrame(() => this.draw());\n        }\n      });\n    }\n\n    for (const filter of namedFilters) {\n      filter.values.randomize();\n\n      const button = document.createElement('button');\n      button.classList.add('filter-button');\n      button.id = `filter-button-${filter.name.toLowerCase()}`;\n      button.setAttribute('aria-label', filter.name);\n      button.tabIndex = 0;\n      button.addEventListener('click', () => this.filterButtonClick(filter));\n\n      const canvas = document.createElement('canvas');\n      canvas.classList.add('filter-thumbnail');\n      button.appendChild(canvas);\n\n      this.filterSection.appendChild(button);\n    }\n\n    this.effectButtons = new Set(this.viewElement.querySelectorAll(\"button.effect-button\")) as Set<HTMLButtonElement>;\n\n    for (const effectButton of this.effectButtons) {\n      effectButton.addEventListener('click', () => this.effectButtonClick(effectButton));\n    }\n\n    this.imageShader = new ImageShader();\n    this.imageShader.setFragmentShader(fragmentShader);\n    this.sourceElement = null;\n    this.sourceWidth = 0;\n    this.sourceHeight = 0;\n    this.destElement.appendChild(this.imageShader.canvas);\n\n    this.currentPanel = null;\n    this.currentRecord = null;\n  }\n\n  async show() {\n    const state = this.getState();\n\n    this.setTransform(state.transform || new FilterTransform());\n\n    if (!state.id) {\n      // TODO: Better handling of errors?\n      throw new Error(`Couldn't get id of image`);\n    }\n\n    const record: ImageRecord = await db.retrieve(state.id);\n    this.currentRecord = record;\n    this.setTransform(record.transform || new FilterTransform());\n    const buffer = record.original;\n    const blob = new Blob([buffer], {type: constants.IMAGE_TYPE});\n\n    const source = document.createElement('img');\n    this.sourceElement = source;\n    source.onload = () => {\n      URL.revokeObjectURL(source.src);\n      this.imageShader.setImage(source);\n      this.sourceWidth = source.naturalWidth;\n      this.sourceHeight = source.naturalHeight;\n      this.animationFrame = requestAnimationFrame(() => this.draw());\n      this.renderThumbnails();\n    };\n    source.src = URL.createObjectURL(blob);\n    super.show();\n  }\n\n  hide() {\n    cancelAnimationFrame(this.animationFrame);\n    this.sourceElement = null;\n    this.animationFrame = 0;\n    this.currentRecord = null;\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n    }\n    super.hide();\n  }\n\n  getState(): ViewState {\n    const state = super.getState();\n    state.transform = state.transform || new FilterTransform();\n    return state;\n  }\n\n  setState(state: ViewState) {\n    if (state.transform) {\n      this.setTransform(state.transform);\n    }\n    super.setState(state);\n  }\n\n  private renderThumbnails() {\n    if (!this.sourceElement) {\n      return;\n    }\n    const aspectRatio = this.sourceWidth / this.sourceHeight;\n\n    const thumbnail = document.createElement('canvas');\n    thumbnail.height = 100 * devicePixelRatio;\n    thumbnail.width = thumbnail.height * aspectRatio;\n    thumbnail.getContext('2d')!.drawImage(this.sourceElement, 0, 0, thumbnail.width, thumbnail.height);\n    const thumbShader = new ImageShader();\n    thumbShader.setFragmentShader(fragmentShader);\n    thumbShader.setImage(thumbnail);\n\n    const relativeSize = thumbnail.height / this.sourceHeight;\n\n    for (const filter of namedFilters) {\n      const output =\n        document.querySelector(`#filter-button-${filter.name.toLowerCase()} .filter-thumbnail`) as HTMLCanvasElement;\n      if (!output) {\n        console.error(`No output thumbnail for filter ${filter.name}`);\n      } else {\n        setTimeout(() => {\n          output.width = thumbnail.width;\n          output.height = thumbnail.height;\n          const context = output.getContext('2d') as CanvasRenderingContext2D;\n          thumbShader.setUniform('sourceSize', new Float32Array([1 / thumbnail.width, 1 / thumbnail.height]));\n\n          const transform = filter.values;\n          // Reduce the blur value relative to the size of the thumbnail\n          thumbShader.setUniform('blur', relativeSize * transform.blur);\n          thumbShader.setUniform('brightness', transform.brightness);\n          thumbShader.setUniform('contrast', transform.contrast);\n          thumbShader.setUniform('grey', transform.grey);\n          thumbShader.setUniform('saturation', transform.saturation);\n          thumbShader.setUniform('sharpen', transform.sharpen);\n          thumbShader.setUniform('vignette', transform.vignette);\n          thumbShader.setUniform('warmth', transform.warmth);\n          thumbShader.render();\n          context.drawImage(\n            thumbShader.canvas,\n            0, 0, thumbShader.canvas.width, thumbShader.canvas.height,\n            0, 0, output.width, output.height);\n        }, 0);\n      }\n    }\n  }\n\n  private setTransform(transform: FilterTransform | {}) {\n    if (transform instanceof FilterTransform) {\n      this.transform = transform;\n    } else {\n      for (const [name] of this.transform) {\n        if (transform[name]) {\n          this.transform[name] = transform[name];\n        }\n      }\n    }\n    for (const [id, slider] of this.sliders) {\n      slider.value = String(this.transform[id] * 50);\n    }\n  }\n\n  private draw() {\n    const canvas = this.imageShader.canvas;\n    canvas.width = this.sourceWidth;\n    canvas.height = this.sourceHeight;\n\n    this.imageShader.setUniform('sourceSize', new Float32Array([1 / canvas.width, 1 / canvas.height]));\n\n    for (const [name, value] of this.transform) {\n      this.imageShader.setUniform(name, value);\n    }\n\n    this.animationFrame = 0;\n\n    this.imageShader.render();\n  }\n\n  private filterButtonClick(filter: NamedFilter) {\n    this.setTransform(filter.values);\n\n    if (!this.animationFrame) {\n      this.animationFrame = requestAnimationFrame(() => this.draw());\n    }\n  }\n\n  private effectButtonClick(button: HTMLButtonElement) {\n    const panel = this.viewElement.querySelector(`#${button.id}-panel`)!;\n\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n\n      if (this.currentPanel !== panel) {\n        this.currentPanel = panel;\n        panel.classList.remove('hidden');\n      } else {\n        this.currentPanel = null;\n      }\n    } else {\n      this.currentPanel = panel;\n      panel.classList.remove('hidden');\n    }\n  }\n\n  private toggleSection() {\n    this.filterSection.classList.toggle('selected');\n    this.tuneSection.classList.toggle('selected');\n    this.filterSectionButton.classList.toggle('selected');\n    this.tuneSectionButton.classList.toggle('selected');\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n      this.currentPanel = null;\n    }\n  }\n\n  private dataUrlToArrayBuffer(dataURI: string): ArrayBuffer {\n    const byteString = atob(dataURI.split(',')[1]);\n    const ia = new Uint8Array(byteString.length);\n    for (let i = 0; i < byteString.length; i++) {\n        ia[i] = byteString.charCodeAt(i);\n    }\n    return ia.buffer as ArrayBuffer;\n  }\n\n  private async canvasToArrayBuffer(canvas: HTMLCanvasElement): Promise<ArrayBuffer> {\n    if (canvas.toBlob) {\n      const blob = await canvasToBlob(canvas, constants.IMAGE_TYPE);\n      const buffer = await blobToArrayBuffer(blob);\n      return buffer;\n    } else {\n      const dataURL = canvas.toDataURL(constants.IMAGE_TYPE);\n      const buffer = this.dataUrlToArrayBuffer(dataURL);\n      return buffer;\n    }\n  }\n\n  private async save(): Promise<void> {\n    this.draw();\n    const buffer = await this.canvasToArrayBuffer(this.imageShader.canvas);\n\n    if (this.currentRecord) {\n      this.currentRecord.edited = buffer;\n      this.currentRecord.transform = this.transform;\n\n      db.store(this.currentRecord);\n    }\n  }\n\n  private closeClick() {\n    router.visit(`/browse`);\n  }\n\n  private acceptClick() {\n    this.save().then(() => {\n      router.visit(`/browse`);\n    });\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport db from '../image-db';\nimport ImageRecord from '../image-record';\nimport {blobToArrayBuffer} from '../promise-helpers';\nimport router from '../router';\nimport View from './view';\n\nexport default class UploadView extends View {\n  private uploadInput: HTMLInputElement;\n  private uploadButton: HTMLButtonElement;\n  private uploadDropTarget: HTMLDivElement;\n  private closeButton: HTMLButtonElement;\n\n  constructor() {\n    super(document.getElementById('upload-view')!);\n\n    this.uploadInput = document.getElementById('upload-file-input')! as HTMLInputElement;\n    this.uploadButton = document.getElementById('upload-button')! as HTMLButtonElement;\n    this.uploadDropTarget = document.getElementById('upload-drop-target')! as HTMLDivElement;\n    this.closeButton = document.getElementById('upload-view-close')! as HTMLButtonElement;\n\n    this.uploadInput.addEventListener('change', () => this.inputChange());\n    this.uploadButton.addEventListener('click', () => this.triggerUpload());\n    this.uploadDropTarget.addEventListener('drop', (e) => this.dropHandler(e));\n    this.uploadDropTarget.addEventListener('dragover', (e) => this.dragOverHandler(e));\n    this.closeButton.addEventListener('click', () => this.close());\n  }\n\n  inputChange() {\n    this.ingest(this.uploadInput.files!);\n  }\n\n  triggerUpload() {\n    this.uploadInput.click();\n  }\n\n  dragOverHandler(e: DragEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n    e.dataTransfer.dropEffect = 'copy';\n  }\n\n  dropHandler(e: DragEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n\n    this.ingest(e.dataTransfer.files);\n  }\n\n  async ingest(files: FileList) {\n    if (files.length === 0) {\n      return;\n    }\n    const file = files[0];\n    const buffer = await blobToArrayBuffer(file);\n    const record = new ImageRecord(buffer);\n    const id = await db.store(record);\n    router.visit(`/edit/${id}`);\n  }\n\n  close() {\n    router.visit(`/browse`);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ViewState from './view-state';\nimport BrowseView from './views/browse-view';\nimport CaptureView from './views/capture-view';\nimport EditView from './views/edit-view';\nimport UploadView from './views/upload-view';\nimport View from './views/view';\n\nclass Router {\n  private currentView: View | null;\n  private currentLocation: string;\n\n  private browseView: BrowseView;\n  private captureView: CaptureView;\n  private editView: EditView;\n  private uploadView: UploadView;\n\n  constructor() {\n    window.addEventListener('popstate', (e) => this.changeHandler(e.state));\n\n    this.browseView = new BrowseView();\n    this.captureView = new CaptureView();\n    this.editView = new EditView();\n    this.uploadView = new UploadView();\n  }\n\n  changeHandler(state?: ViewState) {\n    // TODO: Not sure that I should take the state here\n\n    // Ignore any changes in the hash.\n    if (window.location.pathname === this.currentLocation) {\n      return;\n    }\n    this.currentLocation = window.location.pathname;\n\n    const parts = this.currentLocation.split('/');\n\n    if (this.currentView) {\n      this.currentView.hide();\n    }\n\n    if (!state) {\n      state = new ViewState();\n    }\n\n    let newView: View | null = null;\n\n    switch (parts[1]) {\n      case 'capture':\n        newView = this.captureView;\n        break;\n      case '': // Entry point\n      case 'browse':\n        newView = this.browseView;\n        break;\n      case 'edit':\n        newView = this.editView;\n        state.id = Number(parts[2]);\n        break;\n      case 'upload':\n        newView = this.uploadView;\n        break;\n      default:\n        // TODO: Proper 404\n        console.log('404');\n    }\n\n    if (newView) {\n      this.switch(newView, state);\n    } else {\n      // TODO: Something better?\n      console.log('Oh no, no view found!');\n    }\n  }\n\n  switch(newView: View, state: ViewState) {\n    if (this.currentView) {\n      this.currentView.hide();\n    }\n    newView.setState(state);\n    newView.show();\n    this.currentView = newView;\n  }\n\n  visit(url: string) {\n    if (window.location.href === url) {\n      return;\n    }\n\n    let state;\n\n    if (this.currentView) {\n      state = this.currentView.getState();\n    }\n\n    window.history.replaceState(state, '', window.location.href);\n    window.history.pushState(null, '', url);\n    this.changeHandler();\n  }\n\n  click(event: MouseEvent) {\n    const anchor = event.target as HTMLAnchorElement;\n\n    if (event.metaKey || event.ctrlKey || event.button !== 0) {\n      return;\n    }\n\n    event.preventDefault();\n    this.visit(anchor.href);\n  }\n}\n\nexport default new Router();\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport router from './router';\n\nif ('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js');\n}\n\nrouter.changeHandler();\n"],"names":["IMAGE_TYPE","SUPPORTS_IMAGE_CAPTURE","window","SUPPORTS_MEDIA_DEVICES","navigator","DB_VERSION","constructor","indexedDB","open","dbPromise","Promise","dbResolve","dbReject","onerror","onupgradeneeded","createObjectStore","onsuccess","dbOpened","store","then","transaction","objectStore","put","result","catch","retrieve","get","all","openCursor","push","value","continue","error","console","target","oldVersion","deleteObjectStore","keyPath","autoIncrement","ImageDB","viewElement","show","classList","remove","hide","add","getState","state","ViewState","setState","View","document","getElementById","captureButton","uploadButton","emptyListElement","listElement","constants","addEventListener","captureClick","uploadClick","blobURLs","Set","db","length","createElement","router","visit","id","thumbnail","edited","original","Blob","type","URL","createObjectURL","src","appendChild","hasChildNodes","removeChild","lastChild","revokeObjectURL","clear","toBlob","FileReader","readAsArrayBuffer","streamConstraints","video","deviceId","facingMode","height","ideal","width","supportedConstraints","mediaDevices","getSupportedConstraints","stream","track","trackConstraints","getCameras","enumerateDevices","filter","kind","takePhoto","srcObject","getVideoTracks","ImageCapture","getContext","videoWidth","videoHeight","drawImage","canvasToBlob","stopStream","stop","startStream","getUserMedia","getSettings","getCapabilities","setConstraint","log","applyConstraints","getConstraints","advanced","Object","entries","transform","videoElement","querySelector","videoElement2","takePhotoButton","cameraChooseButton","mirrorButton","closeButton","cameraHelper","CameraHelper","toggleCameraChooser","toggleMirror","close","devicesPromise","getDevices","currentDevice","pause","storeResult","indexOf","blobToArrayBuffer","ImageRecord","onloadedmetadata","play","toggle","random","Math","saturation","warmth","sharpen","blur","brightness","contrast","grey","vignette","Symbol","iterator","bind","randomize","BASE_VERTEX_SHADER","BASE_FRAGMENT_SHADER","POSITIONS","Float32Array","UVS","INDEX","Uint16Array","canvas","Error","context","createTexture","textureId","programId","vertShader","fragShader","uniformLocations","Map","createVAO","clearColor","dirtyProgram","setImage","activeTexture","TEXTURE0","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","setVertexShader","setFragmentShader","setUniform","createProgram","has","warn","FLOAT","uniform1fv","location","FLOAT_VEC2","uniform2fv","FLOAT_VEC3","uniform3fv","FLOAT_VEC4","uniform4fv","BOOL","INT","uniform1iv","BOOL_VEC2","INT_VEC2","uniform2iv","BOOL_VEC3","INT_VEC3","uniform3iv","BOOL_VEC4","INT_VEC4","uniform4iv","render","viewport","drawingBufferWidth","drawingBufferHeight","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","drawElements","TRIANGLES","UNSIGNED_SHORT","flush","compileShader","VERTEX_SHADER","FRAGMENT_SHADER","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","validateProgram","VALIDATE_STATUS","useProgram","getUniformLocations","createShader","shaderSource","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","ACTIVE_UNIFORMS","getActiveUniform","getUniformLocation","name","set","getExtension","createVertexArrayOES","bindVertexArrayOES","bindIndicesBuffer","bindAttributeBuffer","enableVertexAttribArray","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","vertexAttribPointer","ELEMENT_ARRAY_BUFFER","namedFilters","values","FilterTransform","destElement","acceptButton","filterSectionButton","tuneSectionButton","filterSection","tuneSection","closeClick","acceptClick","toggleSection","sliders","getElementsByTagName","Array","from","animationFrame","requestAnimationFrame","draw","toLowerCase","setAttribute","tabIndex","filterButtonClick","effectButtons","querySelectorAll","effectButtonClick","imageShader","ImageShader","fragmentShader","sourceElement","sourceWidth","sourceHeight","currentPanel","currentRecord","setTransform","onload","naturalWidth","naturalHeight","renderThumbnails","cancelAnimationFrame","devicePixelRatio","setTimeout","dataUrlToArrayBuffer","atob","split","Uint8Array","charCodeAt","buffer","canvasToArrayBuffer","toDataURL","save","uploadInput","uploadDropTarget","inputChange","triggerUpload","dropHandler","dragOverHandler","ingest","files","click","stopPropagation","preventDefault","dataTransfer","dropEffect","changeHandler","browseView","BrowseView","captureView","CaptureView","editView","EditView","uploadView","UploadView","pathname","currentLocation","currentView","switch","href","history","replaceState","pushState","metaKey","ctrlKey","button","Router","serviceWorker","register"],"mappings":"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"}