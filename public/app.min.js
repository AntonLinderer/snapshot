'use strict';function __awaiter(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b)).next())})}var constants={SUPPORTS_MEDIA_DEVICES:'mediaDevices'in navigator};const DB_VERSION=2;class ImageDB{constructor(){const a=indexedDB.open('image-db',DB_VERSION);this.dbPromise=new Promise((b,c)=>{this.dbResolve=b,this.dbReject=c,a.onerror=(a)=>this.dbReject(a),a.onupgradeneeded=(a)=>this.createObjectStore(a),a.onsuccess=()=>this.dbOpened(a)})}store(a){const b=new Promise((b,c)=>{this.dbPromise.then((d)=>{const e=d.transaction(['images'],'readwrite'),f=e.objectStore('images').put(a);f.onsuccess=()=>b(f.result),f.onerror=c}).catch(c)});return b}retrieve(a){const b=new Promise((b,c)=>{this.dbPromise.then((d)=>{const e=d.transaction(['images'],'readonly'),f=e.objectStore('images').get(a);f.onsuccess=()=>b(f.result),f.onerror=c}).catch(c)});return b}all(){const a=new Promise((a,b)=>{this.dbPromise.then((c)=>{const d=c.transaction(['images'],'readonly'),e=d.objectStore('images').openCursor(),f=[];e.onsuccess=()=>{const b=e.result;b?(f.push(b.value),b.continue()):a(f)},e.onerror=b}).catch(b)});return a}dbOpened(a){this.dbResolve(a.result),this.dbPromise.then((a)=>{a.onerror=(a)=>this.error(a)})}error(a){console.error(a)}createObjectStore(a){const b=a.target,c=b.result;switch(a.oldVersion){case 1:c.deleteObjectStore('images');case 0:c.createObjectStore('images',{keyPath:'id',autoIncrement:!0});}}}var db=new ImageDB;class ViewState{}class View{constructor(a){this.viewElement=a}show(){this.viewElement.classList.remove('hidden')}hide(){this.viewElement.classList.add('hidden')}getState(){return this.state||new ViewState}setState(a){this.state=a}}class BrowseView extends View{constructor(){super(document.getElementById('browse-view')),this.captureButton=document.getElementById('browse-capture-button'),this.uploadButton=document.getElementById('browse-upload-button'),this.emptyListElement=document.getElementById('empty-browse-list'),this.listElement=document.getElementById('browse-list'),constants.SUPPORTS_MEDIA_DEVICES||this.captureButton.classList.add('hidden'),this.captureButton.addEventListener('click',()=>this.captureClick()),this.uploadButton.addEventListener('click',()=>this.uploadClick()),this.blobURLs=new Set}show(){const a=(a)=>super[a];return __awaiter(this,void 0,void 0,function*(){const b=yield db.all();if(0===b.length)this.emptyListElement.classList.remove('hidden'),this.listElement.classList.add('hidden');else{this.emptyListElement.classList.add('hidden'),this.listElement.classList.remove('hidden');for(const a of b){const b=document.createElement('div');b.classList.add('element'),b.addEventListener('click',()=>router.visit(`/edit/${a.id}`));const c=a.thumbnail||a.edited||a.original;if(c){const a=new Blob([c],{type:'image/jpg'}),d=URL.createObjectURL(a);this.blobURLs.add(d),b.style.backgroundImage=`url(${d})`}this.listElement.appendChild(b)}}a('show').call(this)})}hide(){for(super.hide();this.listElement.hasChildNodes();)this.listElement.removeChild(this.listElement.lastChild);for(const a of this.blobURLs)URL.revokeObjectURL(a);this.blobURLs.clear()}captureClick(){router.visit('/capture')}uploadClick(){router.visit('/upload')}}class ImageRecord{constructor(a){this.original=a,this.edited=null,this.thumbnail=null,this.transform=null}}const streamConstraints={audio:!1,video:{deviceId:'',facingMode:['user','environment'],height:{ideal:1080},width:{ideal:1920}}};class CaptureView extends View{constructor(){super(document.getElementById('capture-view')),this.videoElement=this.viewElement.querySelector('video#preview'),this.videoElement2=this.viewElement.querySelector('video#preview2'),this.takePhotoButton=document.getElementById('capture-button'),this.cameraChooseButton=document.getElementById('camera-choose-button'),this.mirrorButton=document.getElementById('capture-mirror-button'),this.closeButton=document.getElementById('capture-view-close'),this.videoElement2.classList.add('hidden'),this.takePhotoButton.addEventListener('click',()=>this.takePhoto()),this.cameraChooseButton.addEventListener('click',()=>this.toggleCameraChooser()),this.mirrorButton.addEventListener('click',()=>this.toggleMirror()),this.closeButton.addEventListener('click',()=>this.close()),this.devicesPromise=this.getDevices(),this.currentDevice=null}show(){this.devicesPromise.then((a)=>{this.currentDevice=a[0],this.startStream(this.currentDevice.deviceId)}),super.show()}hide(){this.capture&&this.capture.track.stop(),this.videoElement.pause(),super.hide()}getDevices(){return __awaiter(this,void 0,void 0,function*(){let a=[];return constants.SUPPORTS_MEDIA_DEVICES&&(a=yield navigator.mediaDevices.enumerateDevices(),a=a.filter((a)=>'videoinput'===a.kind)),2>a.length?this.cameraChooseButton.classList.add('hidden'):this.cameraChooseButton.classList.remove('hidden'),a})}takePhoto(){if(this.capture)this.capture.takePhoto().then((a)=>this.storeResult(a));else{const a=document.createElement('canvas'),b=a.getContext('2d');a.width=this.videoElement.videoWidth,a.height=this.videoElement.videoHeight,b.drawImage(this.videoElement,0,0),a.toBlob((a)=>this.storeResult(a),'image/jpg')}}toggleCameraChooser(){return __awaiter(this,void 0,void 0,function*(){const a=yield this.devicesPromise;if(!(2>a.length)){if(this.currentDevice){const b=a.indexOf(this.currentDevice);this.currentDevice=a[(b+1)%a.length]}else this.currentDevice=a[0];this.startStream(this.currentDevice.deviceId)}})}close(){router.visit(`/browse`)}storeResult(a){const b=new FileReader;b.addEventListener('loadend',()=>__awaiter(this,void 0,void 0,function*(){const a=b.result,c=new ImageRecord(a),d=yield db.store(c);router.visit(`/edit/${d}`)})),b.readAsArrayBuffer(a)}stopStream(a){for(const b of a.getVideoTracks())b.stop()}startStream(a){const b=this.videoElement.srcObject;b&&this.stopStream(b),streamConstraints.video.deviceId=a,navigator.mediaDevices.getUserMedia(streamConstraints).then((a)=>{if(this.videoElement2.srcObject=a,this.videoElement2.onloadedmetadata=()=>{const a=this.videoElement;this.videoElement=this.videoElement2,this.videoElement2=a,this.videoElement.play(),this.videoElement.classList.remove('hidden'),this.videoElement2.classList.add('hidden'),this.videoElement2.pause()},'ImageCapture'in window){const b=a.getVideoTracks()[0];this.capture=new ImageCapture(b)}}).catch(()=>{})}toggleMirror(){this.videoElement.classList.toggle('mirror')}}var fragmentShader='\nprecision highp float;\nvarying vec2 texCoords;\nuniform sampler2D textureSampler;\nuniform vec2 sourceSize;\nuniform float saturation;\nuniform float warmth;\nuniform float sharpen;\nuniform float brightness;\nuniform float contrast;\nuniform float blur;\nuniform float vignette;\nuniform float grey;\nvec3 saturationVector = vec3(0.299, 0.587, 0.114);\nvoid main() {\n  vec2 off = sourceSize * blur;\n  vec2 off2 = off * 2.0;\n  vec4 tex00 = texture2D(textureSampler, texCoords + vec2(-off2.x, -off2.y));\n  vec4 tex10 = texture2D(textureSampler, texCoords + vec2(-off.x, -off2.y));\n  vec4 tex20 = texture2D(textureSampler, texCoords + vec2(0.0, -off2.y));\n  vec4 tex30 = texture2D(textureSampler, texCoords + vec2(off.x, -off2.y));\n  vec4 tex40 = texture2D(textureSampler, texCoords + vec2(off2.x, -off2.y));\n  vec4 tex01 = texture2D(textureSampler, texCoords + vec2(-off2.x, -off.y));\n  vec4 tex11 = texture2D(textureSampler, texCoords + vec2(-off.x, -off.y));\n  vec4 tex21 = texture2D(textureSampler, texCoords + vec2(0.0, -off.y));\n  vec4 tex31 = texture2D(textureSampler, texCoords + vec2(off.x, -off.y));\n  vec4 tex41 = texture2D(textureSampler, texCoords + vec2(off2.x, -off.y));\n  vec4 tex02 = texture2D(textureSampler, texCoords + vec2(-off2.x, 0.0));\n  vec4 tex12 = texture2D(textureSampler, texCoords + vec2(-off.x, 0.0));\n  vec4 tex22 = texture2D(textureSampler, texCoords + vec2(0.0, 0.0));\n  vec4 tex32 = texture2D(textureSampler, texCoords + vec2(off.x, 0.0));\n  vec4 tex42 = texture2D(textureSampler, texCoords + vec2(off2.x, 0.0));\n  vec4 tex03 = texture2D(textureSampler, texCoords + vec2(-off2.x, off.y));\n  vec4 tex13 = texture2D(textureSampler, texCoords + vec2(-off.x, off.y));\n  vec4 tex23 = texture2D(textureSampler, texCoords + vec2(0.0, off.y));\n  vec4 tex33 = texture2D(textureSampler, texCoords + vec2(off.x, off.y));\n  vec4 tex43 = texture2D(textureSampler, texCoords + vec2(off2.x, off.y));\n  vec4 tex04 = texture2D(textureSampler, texCoords + vec2(-off2.x, off2.y));\n  vec4 tex14 = texture2D(textureSampler, texCoords + vec2(-off.x, off2.y));\n  vec4 tex24 = texture2D(textureSampler, texCoords + vec2(0.0, off2.y));\n  vec4 tex34 = texture2D(textureSampler, texCoords + vec2(off.x, off2.y));\n  vec4 tex44 = texture2D(textureSampler, texCoords + vec2(off2.x, off2.y));\n  vec4 tex = tex22;\n  vec4 blurred = 1.0 * tex00 + 4.0 * tex10 + 6.0 * tex20 + 4.0 * tex30 + 1.0 * tex40\n               + 4.0 * tex01 + 16.0 * tex11 + 24.0 * tex21 + 16.0 * tex31 + 4.0 * tex41\n               + 6.0 * tex02 + 24.0 * tex12 + 36.0 * tex22 + 24.0 * tex32 + 6.0 * tex42\n               + 4.0 * tex03 + 16.0 * tex13 + 24.0 * tex23 + 16.0 * tex33 + 4.0 * tex43\n               + 1.0 * tex04 + 4.0 * tex14 + 6.0 * tex24 + 4.0 * tex34 + 1.0 * tex44;\n  blurred /= 256.0;\n  tex += (tex - blurred) * sharpen;\n  vec3 desaturated = vec3(dot(saturationVector, tex.rgb));\n  vec3 mixed = mix(desaturated, tex.rgb, saturation);\n  vec4 color = vec4(mixed, tex.a);\n  color.r += warmth;\n  color.b -= warmth;\n  vec3 gray = vec3(grey, grey, grey);\n  color.rgb = mix(color.rgb * brightness, mix(gray, color.rgb, contrast), 0.5);\n  float ratio = off.x / off.y;\n  float dist = sqrt(pow(texCoords.x - 0.5, 2.0) + pow(ratio * (texCoords.y - 0.5), 2.0));\n  float vigCurve = exp(-pow(dist, 2.0) / (2.0 * pow(-vignette, 2.0)));\n  color.rgb *= vigCurve;\n  gl_FragColor = color;\n}\n';const random=(a,b)=>{let c=Math.random();return c*=b-a,c+=a,c};class FilterTransform{constructor(){this.saturation=1,this.warmth=0,this.sharpen=0,this.blur=1,this.brightness=1,this.contrast=1,this.grey=0.5,this.vignette=2}[Symbol.iterator](){return function*(){yield['saturation',this.saturation],yield['warmth',this.warmth],yield['sharpen',this.sharpen],yield['blur',this.blur],yield['brightness',this.brightness],yield['contrast',this.contrast],yield['grey',this.grey],yield['vignette',this.vignette]}.bind(this)()}randomize(){this.saturation=random(0,2),this.warmth=random(-0.08,0.08),this.sharpen=random(-2,2),this.blur=random(0.01,4),this.brightness=random(0,2),this.contrast=random(0,2),this.grey=random(0,1),this.vignette=random(0.2,2)}}const BASE_VERTEX_SHADER=`
attribute vec2 position;
attribute vec2 uv;

varying vec2 texCoords;

void main() {
  gl_Position = vec4(position, 0, 1.0);
  texCoords = uv;
}`,BASE_FRAGMENT_SHADER=`
precision highp float;

varying vec2 texCoords;

uniform sampler2D textureSampler;

void main() {
  gl_FragColor = texture2D(textureSampler, texCoords);
}`,POSITIONS=new Float32Array([-1,-1,-1,1,1,1,1,-1]),UVS=new Float32Array([0,1,0,0,1,0,1,1]),INDEX=new Uint16Array([0,1,2,0,2,3]);class ImageShader{constructor(){this.canvas=document.createElement('canvas');const a=this.canvas.getContext('webgl');if(null===a)throw new Error(`Couldn't get a WebGL context`);const b=a;this.context=b;const c=b.createTexture();if(null===c)throw new Error('Error getting texture ID');this.textureId=c,this.programId=0,this.vertShader=BASE_VERTEX_SHADER,this.fragShader=BASE_FRAGMENT_SHADER,this.uniformLocations=new Map,this.createVAO(INDEX,POSITIONS,UVS),b.clearColor(1,1,1,1),this.dirtyProgram=!0}setImage(a){const b=this.context;b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.textureId),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR)}setVertexShader(a){this.vertShader=a,this.dirtyProgram=!0}setFragmentShader(a){this.fragShader=a,this.dirtyProgram=!0}setUniform(a,b){const c=this.context;if(this.dirtyProgram&&this.createProgram(),!this.uniformLocations.has(a))return void console.warn(`Tried to set unknown uniform ${a}`);const d=this.uniformLocations.get(a);switch(d.type){case c.FLOAT:c.uniform1fv(d.location,[b]);break;case c.FLOAT_VEC2:c.uniform2fv(d.location,b);break;case c.FLOAT_VEC3:c.uniform3fv(d.location,b);break;case c.FLOAT_VEC4:c.uniform4fv(d.location,b);break;case c.BOOL:case c.INT:c.uniform1iv(d.location,[b]);break;case c.BOOL_VEC2:case c.INT_VEC2:c.uniform2iv(d.location,b);break;case c.BOOL_VEC3:case c.INT_VEC3:c.uniform3iv(d.location,b);break;case c.BOOL_VEC4:case c.INT_VEC4:c.uniform4iv(d.location,b);break;default:console.error(`Couldn't set uniform, unsupported type`);}}render(){const a=this.context;this.dirtyProgram&&this.createProgram(),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0),a.flush()}createProgram(){const a=this.context,b=this.compileShader(this.vertShader,a.VERTEX_SHADER),c=this.compileShader(this.fragShader,a.FRAGMENT_SHADER),d=a.createProgram();if(null===d)throw new Error(`Couldn't get a program ID`);if(this.programId=d,a.attachShader(d,b),a.attachShader(d,c),a.linkProgram(d),!a.getProgramParameter(d,a.LINK_STATUS)){const b=a.getProgramInfoLog(d);throw new Error('Could not link shader program. \n\n'+b)}if(a.validateProgram(d),!a.getProgramParameter(d,a.VALIDATE_STATUS)){const b=a.getProgramInfoLog(d);throw new Error('Could not validate shader program. \n\n'+b)}a.useProgram(d),this.uniformLocations=new Map,this.getUniformLocations(),this.dirtyProgram=!1}compileShader(a,b){const c=this.context,d=c.createShader(b);if(null===d)throw new Error('Error creating shader');if(c.shaderSource(d,a),c.compileShader(d),!c.getShaderParameter(d,c.COMPILE_STATUS))throw new Error(`Couldn't compiler shader: ${c.getShaderInfoLog(d)}`);return d}getUniformLocations(){const a=this.context,b=a.getProgramParameter(this.programId,a.ACTIVE_UNIFORMS);for(let c=0;c<b;c++){const b=a.getActiveUniform(this.programId,c);if(null===b)throw new Error(`Couldn't get uniform info`);const d=a.getUniformLocation(this.programId,b.name);d&&this.uniformLocations.set(b.name,{type:b.type,location:d})}}createVAO(a,b,c){const d=this.context,e=d.getExtension('OES_vertex_array_object');if(!e)throw new Error(`Browser doesn't support VAOs`);const f=e.createVertexArrayOES();e.bindVertexArrayOES(f),this.bindIndicesBuffer(a),this.bindAttributeBuffer(0,2,b),this.bindAttributeBuffer(1,2,c),d.enableVertexAttribArray(0),d.enableVertexAttribArray(1)}bindAttributeBuffer(a,b,c){const d=this.context,e=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,e),d.bufferData(d.ARRAY_BUFFER,c,d.STATIC_DRAW),d.vertexAttribPointer(a,b,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,null)}bindIndicesBuffer(a){const b=this.context,c=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c),b.bufferData(b.ELEMENT_ARRAY_BUFFER,a,b.STATIC_DRAW)}}const namedFilters=[{name:'Grimsby',values:new FilterTransform},{name:'Slough',values:new FilterTransform},{name:'Burnley',values:new FilterTransform},{name:'Carlisle',values:new FilterTransform},{name:'Stevenage',values:new FilterTransform},{name:'Hull',values:new FilterTransform},{name:'Swansea',values:new FilterTransform},{name:'Luton',values:new FilterTransform},{name:'Glasgow',values:new FilterTransform},{name:'Dull',values:new FilterTransform}];class EditView extends View{constructor(){super(document.getElementById('edit-view')),this.destElement=document.getElementById('edit-dest'),this.closeButton=document.getElementById('edit-view-close'),this.acceptButton=document.getElementById('edit-view-accept'),this.filterSectionButton=document.getElementById('edit-select-filters'),this.tuneSectionButton=document.getElementById('edit-select-tuning'),this.filterSection=document.getElementById('edit-filter'),this.tuneSection=document.getElementById('edit-tune'),this.closeButton.addEventListener('click',()=>this.closeClick()),this.acceptButton.addEventListener('click',()=>this.acceptClick()),this.filterSectionButton.addEventListener('click',()=>this.toggleSection()),this.tuneSectionButton.addEventListener('click',()=>this.toggleSection()),this.transform=new FilterTransform,this.sliders=new Map;const a=this.viewElement.getElementsByTagName('input');for(const b of Array.from(a))this.sliders.set(b.id,b),b.addEventListener('input',()=>{this.transform[b.id]=+b.value/50,this.animationFrame||(this.animationFrame=requestAnimationFrame(()=>this.draw()))});for(const a of namedFilters){a.values.randomize();const b=document.createElement('button');b.classList.add('filter-button'),b.id=`filter-button-${a.name.toLowerCase()}`,b.setAttribute('aria-label',a.name),b.tabIndex=0,b.addEventListener('click',()=>this.filterButtonClick(a));const c=document.createElement('canvas');c.classList.add('filter-thumbnail'),b.appendChild(c),this.filterSection.appendChild(b)}this.effectButtons=new Set(this.viewElement.querySelectorAll('button.effect-button'));for(const a of this.effectButtons)a.addEventListener('click',()=>this.effectButtonClick(a));this.imageShader=new ImageShader,this.imageShader.setFragmentShader(fragmentShader),this.destElement.appendChild(this.imageShader.canvas),this.currentPanel=null,this.currentRecord=null}show(){const a=this.getState();if(this.setTransform(a.transform||new FilterTransform),!a.id)throw new Error(`Couldn't get id of image`);this.imageElement=document.createElement('img'),this.imageElement.onload=()=>{URL.revokeObjectURL(this.imageElement.src),this.imageShader.setImage(this.imageElement),this.animationFrame=requestAnimationFrame(()=>this.draw());const a=this.imageElement.naturalWidth/this.imageElement.naturalHeight,b=document.createElement('canvas');b.height=100*devicePixelRatio,b.width=b.height*a,b.getContext('2d').drawImage(this.imageElement,0,0,b.width,b.height);const c=new ImageShader;c.setFragmentShader(fragmentShader),c.setImage(b);const d=b.height/this.imageElement.naturalHeight;for(const a of namedFilters){const e=document.querySelector(`#filter-button-${a.name.toLowerCase()} .filter-thumbnail`);e?setTimeout(()=>{e.width=b.width,e.height=b.height;const f=e.getContext('2d');c.setUniform('sourceSize',new Float32Array([1/b.width,1/b.height]));const g=a.values;c.setUniform('blur',d*g.blur),c.setUniform('brightness',g.brightness),c.setUniform('contrast',g.contrast),c.setUniform('grey',g.grey),c.setUniform('saturation',g.saturation),c.setUniform('sharpen',g.sharpen),c.setUniform('vignette',g.vignette),c.setUniform('warmth',g.warmth),c.render(),f.drawImage(c.canvas,0,0,c.canvas.width,c.canvas.height,0,0,e.width,e.height)},0):console.error(`No output thumbnail for filter ${a.name}`)}},db.retrieve(a.id).then((a)=>{this.currentRecord=a,this.setTransform(a.transform||new FilterTransform);const b=a.original,c=new Blob([b],{type:'image/jpeg'});this.imageElement.src=URL.createObjectURL(c)}),super.show()}hide(){cancelAnimationFrame(this.animationFrame),this.animationFrame=0,this.currentRecord=null,this.currentPanel&&this.currentPanel.classList.add('hidden'),super.hide()}getState(){const a=super.getState();return a.transform=a.transform||new FilterTransform,a}setState(a){a.transform&&this.setTransform(a.transform),super.setState(a)}setTransform(a){if(a instanceof FilterTransform)this.transform=a;else for(const[b]of this.transform)a[b]&&(this.transform[b]=a[b]);for(const[b,c]of this.sliders)c.value=50*this.transform[b]+''}draw(){const a=this.imageShader.canvas;a.width=this.imageElement.naturalWidth,a.height=this.imageElement.naturalHeight,this.imageShader.setUniform('sourceSize',new Float32Array([1/a.width,1/a.height]));for(const[a,b]of this.transform)this.imageShader.setUniform(a,b);this.animationFrame=0,this.imageShader.render()}filterButtonClick(a){this.setTransform(a.values),this.animationFrame||(this.animationFrame=requestAnimationFrame(()=>this.draw()))}effectButtonClick(a){const b=this.viewElement.querySelector(`#${a.id}-panel`);this.currentPanel?(this.currentPanel.classList.add('hidden'),this.currentPanel===b?this.currentPanel=null:(this.currentPanel=b,b.classList.remove('hidden'))):(this.currentPanel=b,b.classList.remove('hidden'))}toggleSection(){this.filterSection.classList.toggle('selected'),this.tuneSection.classList.toggle('selected'),this.filterSectionButton.classList.toggle('selected'),this.tuneSectionButton.classList.toggle('selected'),this.currentPanel&&(this.currentPanel.classList.add('hidden'),this.currentPanel=null)}dataUrlToArrayBuffer(a){const b=atob(a.split(',')[1]),c=new Uint8Array(b.length);for(let d=0;d<b.length;d++)c[d]=b.charCodeAt(d);return c.buffer}BlobToArrayBuffer(a){return new Promise((b)=>{const c=new FileReader;c.addEventListener('loadend',()=>b(c.result)),c.readAsArrayBuffer(a)})}canvasToArrayBuffer(a){if(a.toBlob)return new Promise((b,c)=>{a.toBlob((a)=>{if(a){const c=new FileReader;c.addEventListener('loadend',()=>b(c.result)),c.readAsArrayBuffer(a)}else c()},'image/jpeg')});const b=a.toDataURL('image/jpeg'),c=this.dataUrlToArrayBuffer(b);return Promise.resolve(c)}save(){return __awaiter(this,void 0,void 0,function*(){this.draw();const a=yield this.canvasToArrayBuffer(this.imageShader.canvas);this.currentRecord&&(this.currentRecord.edited=a,this.currentRecord.transform=this.transform,db.store(this.currentRecord))})}closeClick(){router.visit(`/browse`)}acceptClick(){this.save().then(()=>{router.visit(`/browse`)})}}class UploadView extends View{constructor(){super(document.getElementById('upload-view')),this.uploadInput=document.getElementById('upload-file-input'),this.uploadButton=document.getElementById('upload-button'),this.uploadDropTarget=document.getElementById('upload-drop-target'),this.closeButton=document.getElementById('upload-view-close'),this.uploadInput.addEventListener('change',()=>this.inputChange()),this.uploadButton.addEventListener('click',()=>this.triggerUpload()),this.uploadDropTarget.addEventListener('drop',(a)=>this.dropHandler(a)),this.uploadDropTarget.addEventListener('dragover',(a)=>this.dragOverHandler(a)),this.closeButton.addEventListener('click',()=>this.close())}inputChange(){this.ingest(this.uploadInput.files)}triggerUpload(){this.uploadInput.click()}dragOverHandler(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect='copy'}dropHandler(a){a.stopPropagation(),a.preventDefault(),this.ingest(a.dataTransfer.files)}ingest(a){if(0===a.length)return;const b=a[0],c=new FileReader;c.addEventListener('loadend',()=>__awaiter(this,void 0,void 0,function*(){const a=c.result,b=new ImageRecord(a),d=yield db.store(b);router.visit(`/edit/${d}`)})),c.readAsArrayBuffer(b)}close(){router.visit(`/browse`)}}class Router{constructor(){window.addEventListener('popstate',(a)=>this.changeHandler(a.state)),this.browseView=new BrowseView,this.captureView=new CaptureView,this.editView=new EditView,this.uploadView=new UploadView}changeHandler(a){if(window.location.pathname===this.currentLocation)return;this.currentLocation=window.location.pathname;const b=this.currentLocation.split('/');this.currentView&&this.currentView.hide(),a||(a=new ViewState);let c=null;switch(b[1]){case'capture':c=this.captureView;break;case'':case'browse':c=this.browseView;break;case'edit':c=this.editView,a.id=+b[2];break;case'upload':c=this.uploadView;break;default:console.log('404');}c?this.switch(c,a):console.log('Oh no, no view found!')}switch(a,b){this.currentView&&this.currentView.hide(),a.setState(b),a.show(),this.currentView=a}visit(a){if(window.location.href===a)return;let b;this.currentView&&(b=this.currentView.getState()),window.history.replaceState(b,'',window.location.href),window.history.pushState(null,'',a),this.changeHandler()}click(a){const b=a.target;a.metaKey||a.ctrlKey||0!==a.button||(a.preventDefault(),this.visit(b.href))}}var router=new Router;'serviceWorker'in navigator&&navigator.serviceWorker.register('/sw.js'),router.changeHandler();
